name: build

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-amd64
            os: ubuntu-latest
            goos: linux
            goarch: amd64
            bin: db-ferry
            archive_suffix: linux-amd64
          - name: windows-amd64
            os: windows-latest
            goos: windows
            goarch: amd64
            bin: db-ferry.exe
            archive_suffix: windows-amd64
          - name: mac-universal
            os: macos-latest
            bin: db-ferry
            archive_suffix: darwin-universal

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install MSYS2 (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc
          path-type: inherit

      - name: Download dependencies
        run: go mod download

      - name: Set artifact name
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
            latest_tag="${latest_tag#v}"
            short_sha=$(git rev-parse --short=7 HEAD)
            version="${latest_tag}-${short_sha}"
          fi
          echo "VERSION=${version}" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=db-ferry-${version}-${{ matrix.archive_suffix }}.tgz" >> $GITHUB_ENV

      - name: Build (Linux)
        if: matrix.name == 'linux-amd64'
        env:
          CGO_ENABLED: "1"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          go build -o dist/${{ matrix.bin }}

      - name: Build (Windows)
        if: matrix.name == 'windows-amd64'
        shell: msys2 {0}
        env:
          CGO_ENABLED: "1"
          GOOS: windows
          GOARCH: amd64
        run: |
          mkdir -p dist
          go build -o dist/${{ matrix.bin }}

      - name: Build (macOS universal)
        if: matrix.name == 'mac-universal'
        env:
          CGO_ENABLED: "1"
        run: |
          mkdir -p dist
          GOOS=darwin GOARCH=amd64 go build -o dist/db-ferry-darwin-amd64
          GOOS=darwin GOARCH=arm64 go build -o dist/db-ferry-darwin-arm64
          lipo -create -output dist/${{ matrix.bin }} dist/db-ferry-darwin-amd64 dist/db-ferry-darwin-arm64

      - name: Package (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          tar -czf dist/${{ env.ARCHIVE_NAME }} -C dist ${{ matrix.bin }}

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          tar -czf dist/${{ env.ARCHIVE_NAME }} -C dist ${{ matrix.bin }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: dist/${{ env.ARCHIVE_NAME }}
